#!/usr/bin/env bash
# /usr/local/bin/lunariod-install
# Lunariod TUI Installer — dialog front-end → pacstrap back-end
# Replaces broken archinstall approach with manual partitioning + pacstrap
set -uo pipefail

###############################################################################
# Constants
###############################################################################
LOGFILE="/tmp/lunariod-install.log"
DIALOG_TITLE=" Lunariod Installer "
DIALOG_BT="Lunariod Linux — Installation"
MOUNTPOINT="/mnt"

: > "$LOGFILE"
log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
log "=== Lunariod installer started ==="

###############################################################################
# Helpers
###############################################################################
die() {
    log "FATAL: $1"
    dialog --title "Error" --backtitle "$DIALOG_BT" --msgbox "$1" 8 60 2>/dev/null
    cleanup_mounts
    exit 1
}

info_box() {
    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --infobox "$1" 5 60
}

gauge_box() {
    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --gauge "$1" 7 60 "$2"
}

cleanup_mounts() {
    umount -R "$MOUNTPOINT" 2>/dev/null || true
    swapoff -a 2>/dev/null || true
}

check_prereqs() {
    local missing=()
    for cmd in dialog pacstrap genfstab arch-chroot lsblk sgdisk mkfs.ext4; do
        command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
    done
    [[ ${#missing[@]} -eq 0 ]] || die "Missing commands: ${missing[*]}"
    [[ $(id -u) -eq 0 ]] || die "Installer must be run as root."

    # Ensure NetworkManager is running
    if ! systemctl is-active --quiet NetworkManager 2>/dev/null; then
        info_box "Starting NetworkManager..."
        systemctl start NetworkManager 2>>"$LOGFILE" || true
        sleep 3
    fi

    # Wait for network (up to 15 seconds)
    info_box "Checking network connectivity..."
    local tries=0
    while [[ $tries -lt 5 ]]; do
        if ping -c1 -W3 archlinux.org >/dev/null 2>&1; then
            log "Network OK"
            return 0
        fi
        tries=$((tries + 1))
        sleep 2
    done
    die "No network. Connect first:\n  nmtui  or\n  nmcli device wifi connect SSID password PASS"
}

###############################################################################
# Detect boot mode (UEFI vs BIOS)
###############################################################################
is_uefi() {
    [[ -d /sys/firmware/efi/efivars ]]
}

###############################################################################
# Input Collection
###############################################################################
get_disk() {
    local items=()
    while IFS= read -r line; do
        local dev size
        dev=$(echo "$line" | awk '{print $1}')
        size=$(echo "$line" | awk '{print $2}')
        items+=("$dev" "$size")
    done < <(lsblk -dpno NAME,SIZE | grep -vE 'loop|sr|ram|rom')
    [[ ${#items[@]} -gt 0 ]] || die "No disks found."
    DISK=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --menu "\nSelect installation disk:" 15 55 6 \
        "${items[@]}" 2>&1 >/dev/tty) || exit 1
    log "Disk: $DISK"
}

get_hostname() {
    INSTALL_HOSTNAME=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nHostname:" 9 45 "lunariod" 2>&1 >/dev/tty) || exit 1
    INSTALL_HOSTNAME="${INSTALL_HOSTNAME:-lunariod}"
    log "Hostname: $INSTALL_HOSTNAME"
}

get_username() {
    USERNAME=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nUsername (will have sudo):" 9 50 "" 2>&1 >/dev/tty) || exit 1
    [[ -n "$USERNAME" ]] || die "Username cannot be empty."
    [[ "$USERNAME" =~ ^[a-z][a-z0-9_-]*$ ]] || die "Invalid username.\nUse lowercase, start with a letter."
    log "Username: $USERNAME"
}

get_password() {
    local p1 p2
    p1=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --insecure --passwordbox "\nPassword:" 9 45 2>&1 >/dev/tty) || exit 1
    p2=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --insecure --passwordbox "\nConfirm password:" 9 45 2>&1 >/dev/tty) || exit 1
    [[ "$p1" == "$p2" ]] || die "Passwords do not match."
    [[ -n "$p1" ]] || die "Password cannot be empty."
    PASSWORD="$p1"
    log "Password: [set]"
}

get_timezone() {
    TIMEZONE=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nTimezone (e.g. America/New_York, Asia/Kolkata):" \
        9 60 "UTC" 2>&1 >/dev/tty) || exit 1
    TIMEZONE="${TIMEZONE:-UTC}"
    if [[ ! -f "/usr/share/zoneinfo/${TIMEZONE}" ]]; then
        die "Invalid timezone: $TIMEZONE"
    fi
    log "Timezone: $TIMEZONE"
}

get_filesystem() {
    FILESYSTEM=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --menu "\nRoot filesystem:" 11 45 2 \
        "ext4" "Stable, recommended" \
        "btrfs" "CoW, snapshots" \
        2>&1 >/dev/tty) || exit 1
    log "Filesystem: $FILESYSTEM"
}

###############################################################################
# Partitioning
###############################################################################
partition_disk() {
    info_box "Partitioning $DISK..."
    log "Partitioning $DISK (UEFI=$(is_uefi && echo yes || echo no))"

    # Wipe existing partition table
    sgdisk --zap-all "$DISK" >> "$LOGFILE" 2>&1

    if is_uefi; then
        # GPT: 512M EFI + rest as root
        sgdisk -n 1:0:+512M -t 1:EF00 -c 1:"EFI" "$DISK" >> "$LOGFILE" 2>&1
        sgdisk -n 2:0:0 -t 2:8300 -c 2:"Root" "$DISK" >> "$LOGFILE" 2>&1

        # Determine partition naming (nvme uses p1, sda uses 1)
        if [[ "$DISK" == *nvme* ]] || [[ "$DISK" == *mmcblk* ]]; then
            EFI_PART="${DISK}p1"
            ROOT_PART="${DISK}p2"
        else
            EFI_PART="${DISK}1"
            ROOT_PART="${DISK}2"
        fi
    else
        # MBR/BIOS: just one big root partition
        sgdisk -n 1:0:0 -t 1:8300 -c 1:"Root" "$DISK" >> "$LOGFILE" 2>&1

        if [[ "$DISK" == *nvme* ]] || [[ "$DISK" == *mmcblk* ]]; then
            ROOT_PART="${DISK}p1"
        else
            ROOT_PART="${DISK}1"
        fi
        EFI_PART=""
    fi

    # Wait for kernel to recognize partitions
    partprobe "$DISK" 2>/dev/null || true
    sleep 2

    log "Partitions: EFI=$EFI_PART ROOT=$ROOT_PART"
}

###############################################################################
# Formatting
###############################################################################
format_partitions() {
    info_box "Formatting partitions..."

    # Format EFI partition if UEFI
    if [[ -n "${EFI_PART:-}" ]]; then
        mkfs.fat -F32 "$EFI_PART" >> "$LOGFILE" 2>&1 || die "Failed to format EFI partition"
        log "Formatted EFI: $EFI_PART (FAT32)"
    fi

    # Format root partition
    case "$FILESYSTEM" in
        ext4)
            mkfs.ext4 -F "$ROOT_PART" >> "$LOGFILE" 2>&1 || die "Failed to format root partition"
            ;;
        btrfs)
            mkfs.btrfs -f "$ROOT_PART" >> "$LOGFILE" 2>&1 || die "Failed to format root partition"
            ;;
    esac
    log "Formatted root: $ROOT_PART ($FILESYSTEM)"
}

###############################################################################
# Mounting
###############################################################################
mount_partitions() {
    info_box "Mounting partitions..."

    # Mount root
    mount "$ROOT_PART" "$MOUNTPOINT" >> "$LOGFILE" 2>&1 || die "Failed to mount root partition"

    # Create and mount EFI if UEFI
    if [[ -n "${EFI_PART:-}" ]]; then
        mkdir -p "$MOUNTPOINT/boot/efi"
        mount "$EFI_PART" "$MOUNTPOINT/boot/efi" >> "$LOGFILE" 2>&1 || die "Failed to mount EFI partition"
    fi

    log "Mounted: root=$MOUNTPOINT, EFI=$MOUNTPOINT/boot/efi"
}

###############################################################################
# Package Installation via pacstrap
###############################################################################
install_packages() {
    info_box "Installing base system (this takes 10-30 min)...\nLog: $LOGFILE"
    log "=== Running pacstrap ==="

    local packages=(
        # Base system
        base linux linux-firmware intel-ucode sudo

        # Bootloader
        grub efibootmgr

        # Intel Graphics + Vulkan (+ 32-bit for Steam)
        mesa lib32-mesa
        vulkan-intel lib32-vulkan-intel
        vulkan-icd-loader lib32-vulkan-icd-loader

        # Audio (PipeWire)
        pipewire pipewire-alsa pipewire-pulse pipewire-jack
        wireplumber

        # Networking
        networkmanager iwd

        # Hyprland / Wayland
        hyprland xdg-desktop-portal-hyprland xdg-desktop-portal
        waybar wofi mako hyprpaper foot
        polkit-gnome grim slurp wl-clipboard xdg-utils
        xorg-xwayland

        # Gaming
        steam gamescope gamemode lib32-gamemode
        mangohud lib32-mangohud

        # Coding + Browser
        base-devel git python nodejs npm firefox

        # Flatpak
        flatpak

        # VirtualBox Guest
        virtualbox-guest-utils

        # Fonts
        ttf-jetbrains-mono-nerd noto-fonts

        # Icons
        papirus-icon-theme

        # Shell + Utilities
        zsh nano vim less

        # File manager
        nemo
    )

    pacstrap -K "$MOUNTPOINT" "${packages[@]}" >> "$LOGFILE" 2>&1
    if [[ $? -ne 0 ]]; then
        die "pacstrap failed. Check $LOGFILE for details."
    fi

    log "pacstrap completed successfully"
}

###############################################################################
# Generate fstab
###############################################################################
generate_fstab() {
    info_box "Generating fstab..."
    genfstab -U "$MOUNTPOINT" >> "$MOUNTPOINT/etc/fstab"
    log "fstab generated"
}

###############################################################################
# System Configuration (inside chroot)
###############################################################################
configure_system() {
    info_box "Configuring system..."
    log "=== Configuring system in chroot ==="

    # Timezone
    arch-chroot "$MOUNTPOINT" ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime >> "$LOGFILE" 2>&1
    arch-chroot "$MOUNTPOINT" hwclock --systohc >> "$LOGFILE" 2>&1
    log "Timezone set: $TIMEZONE"

    # Locale
    echo "en_US.UTF-8 UTF-8" > "$MOUNTPOINT/etc/locale.gen"
    arch-chroot "$MOUNTPOINT" locale-gen >> "$LOGFILE" 2>&1
    echo "LANG=en_US.UTF-8" > "$MOUNTPOINT/etc/locale.conf"
    log "Locale configured"

    # Hostname
    echo "$INSTALL_HOSTNAME" > "$MOUNTPOINT/etc/hostname"
    cat > "$MOUNTPOINT/etc/hosts" <<EOF
127.0.0.1   localhost
::1         localhost
127.0.1.1   ${INSTALL_HOSTNAME}.localdomain ${INSTALL_HOSTNAME}
EOF
    log "Hostname set: $INSTALL_HOSTNAME"

    # Enable multilib
    sed -i '/^#\[multilib\]/{s/^#//;n;s/^#//}' "$MOUNTPOINT/etc/pacman.conf" 2>/dev/null || true
    log "Multilib enabled"

    # Create user
    arch-chroot "$MOUNTPOINT" useradd -m -G wheel,video,audio,input -s /bin/bash "$USERNAME" >> "$LOGFILE" 2>&1
    echo "${USERNAME}:${PASSWORD}" | arch-chroot "$MOUNTPOINT" chpasswd >> "$LOGFILE" 2>&1
    log "User created: $USERNAME"

    # Enable sudo for wheel
    sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' "$MOUNTPOINT/etc/sudoers" 2>/dev/null || true
    log "Sudo enabled for wheel group"

    # Bootloader
    install_bootloader

    # Enable services
    info_box "Enabling services..."
    arch-chroot "$MOUNTPOINT" systemctl enable NetworkManager.service >> "$LOGFILE" 2>&1 || true
    arch-chroot "$MOUNTPOINT" systemctl enable vboxservice.service >> "$LOGFILE" 2>&1 || true
    log "Services enabled"

    # Gaming tweak — increase vm.max_map_count for Steam/Proton
    echo "vm.max_map_count=2147483642" > "$MOUNTPOINT/etc/sysctl.d/80-gamecompatibility.conf" 2>/dev/null || true
    log "Gaming tweaks applied"
}

###############################################################################
# Bootloader Installation
###############################################################################
install_bootloader() {
    info_box "Installing bootloader..."
    log "Installing GRUB bootloader"

    if is_uefi; then
        arch-chroot "$MOUNTPOINT" grub-install --target=x86_64-efi \
            --efi-directory=/boot/efi --bootloader-id=Lunariod >> "$LOGFILE" 2>&1 \
            || die "GRUB install failed (UEFI)"
    else
        arch-chroot "$MOUNTPOINT" grub-install --target=i386-pc "$DISK" >> "$LOGFILE" 2>&1 \
            || die "GRUB install failed (BIOS)"
    fi

    # Customize GRUB
    sed -i 's/GRUB_DISTRIBUTOR="Arch"/GRUB_DISTRIBUTOR="Lunariod"/' \
        "$MOUNTPOINT/etc/default/grub" 2>/dev/null || true

    arch-chroot "$MOUNTPOINT" grub-mkconfig -o /boot/grub/grub.cfg >> "$LOGFILE" 2>&1 \
        || die "grub-mkconfig failed"

    log "GRUB installed and configured"
}

###############################################################################
# Post-Install (Flatpak, configs, branding)
###############################################################################
post_install() {
    info_box "Running post-install setup..."
    log "=== Post-install ==="

    # Flatpak + Flathub
    info_box "Setting up Flatpak + Flathub..."
    arch-chroot "$MOUNTPOINT" flatpak remote-add --if-not-exists \
        flathub https://dl.flathub.org/repo/flathub.flatpakrepo >> "$LOGFILE" 2>&1 || true

    # VS Code (Flatpak)
    info_box "Installing VS Code (Flatpak)..."
    arch-chroot "$MOUNTPOINT" flatpak install -y --noninteractive \
        flathub com.visualstudio.code >> "$LOGFILE" 2>&1 || true

    # Prism Launcher (Flatpak)
    info_box "Installing Prism Launcher (Flatpak)..."
    arch-chroot "$MOUNTPOINT" flatpak install -y --noninteractive \
        flathub org.prismlauncher.PrismLauncher >> "$LOGFILE" 2>&1 || true

    # Deploy user desktop configs from skel
    local user_home="$MOUNTPOINT/home/${USERNAME}"
    if [[ -d "$user_home" ]]; then
        info_box "Deploying desktop configs..."
        mkdir -p "$user_home/.config"
        cp -r /etc/skel/.config/hypr "$user_home/.config/" 2>/dev/null || true
        cp -r /etc/skel/.config/waybar "$user_home/.config/" 2>/dev/null || true
        cp -r /etc/skel/.config/wofi "$user_home/.config/" 2>/dev/null || true
        cp -r /etc/skel/.config/foot "$user_home/.config/" 2>/dev/null || true
        arch-chroot "$MOUNTPOINT" chown -R "${USERNAME}:${USERNAME}" "/home/${USERNAME}/.config" >> "$LOGFILE" 2>&1 || true
    fi

    # Branding — copy os-release
    [[ -f /etc/os-release ]] && cp /etc/os-release "$MOUNTPOINT/etc/os-release" 2>/dev/null || true

    # Create Hyprland autostart for the user (login shell launches Hyprland)
    cat > "$user_home/.bash_profile" <<'EOF'
# Lunariod — Auto-launch Hyprland on tty1
if [[ -z "$DISPLAY" ]] && [[ -z "$WAYLAND_DISPLAY" ]] && [[ $(tty) == /dev/tty1 ]]; then
    exec Hyprland
fi

# Source bashrc
[[ -f ~/.bashrc ]] && . ~/.bashrc
EOF
    arch-chroot "$MOUNTPOINT" chown "${USERNAME}:${USERNAME}" "/home/${USERNAME}/.bash_profile" >> "$LOGFILE" 2>&1 || true

    log "Post-install complete"
}

###############################################################################
# Main
###############################################################################
main() {
    check_prereqs

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --yesno \
        "\n  Welcome to Lunariod!\n\n  This will install Lunariod Linux.\n\n  Continue?" \
        11 50 || exit 0

    get_disk
    get_hostname
    get_username
    get_password
    get_timezone
    get_filesystem

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --yesno \
        "\nInstall with these settings?\n\n  Disk:       $DISK\n  Hostname:   $INSTALL_HOSTNAME\n  Username:   $USERNAME\n  Timezone:   $TIMEZONE\n  Filesystem: $FILESYSTEM\n\n  WARNING: $DISK will be ERASED!" 16 55 || exit 0

    # === Actual Installation ===
    partition_disk
    format_partitions
    mount_partitions
    install_packages
    generate_fstab
    configure_system
    post_install

    # Cleanup
    cleanup_mounts

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --msgbox \
        "\n  Installation complete!\n\n  Remove the media and reboot.\n\n  Log: $LOGFILE" 12 55

    log "=== Installer finished ==="
}

main "$@"
