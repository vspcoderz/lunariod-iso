#!/usr/bin/env bash
# /usr/local/bin/lunariod-install
# Lunariod TUI Installer — dialog front-end → archinstall back-end
set -uo pipefail

###############################################################################
# Constants
###############################################################################
LOGFILE="/tmp/lunariod-install.log"
CONFIG="/tmp/lunariod-config.json"
CREDS="/tmp/lunariod-creds.json"
DIALOG_TITLE=" Lunariod Installer "
DIALOG_BT="Lunariod Linux — Installation"
MOUNTPOINT="/mnt/archinstall"

: > "$LOGFILE"
log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
log "=== Lunariod installer started ==="

###############################################################################
# Helpers
###############################################################################
die() {
    log "FATAL: $1"
    dialog --title "Error" --backtitle "$DIALOG_BT" --msgbox "$1" 8 60 2>/dev/null
    exit 1
}

info_box() {
    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --infobox "$1" 5 60
}

check_prereqs() {
    local missing=()
    for cmd in dialog archinstall lsblk; do
        command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
    done
    [[ ${#missing[@]} -eq 0 ]] || die "Missing commands: ${missing[*]}"
    [[ $(id -u) -eq 0 ]] || die "Installer must be run as root."
    if ! ping -c1 -W3 archlinux.org >/dev/null 2>&1; then
        die "No network. Connect first:\n  nmtui  or\n  nmcli device wifi connect SSID password PASS"
    fi
}

###############################################################################
# Input Collection
###############################################################################
get_disk() {
    local items=()
    while IFS= read -r line; do
        local dev size
        dev=$(echo "$line" | awk '{print $1}')
        size=$(echo "$line" | awk '{print $2}')
        items+=("$dev" "$size")
    done < <(lsblk -dpno NAME,SIZE | grep -vE 'loop|sr|ram|rom')
    [[ ${#items[@]} -gt 0 ]] || die "No disks found."
    DISK=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --menu "\nSelect installation disk:" 15 55 6 \
        "${items[@]}" 2>&1 >/dev/tty) || exit 1
    log "Disk: $DISK"
}

get_hostname() {
    INSTALL_HOSTNAME=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nHostname:" 9 45 "lunariod" 2>&1 >/dev/tty) || exit 1
    INSTALL_HOSTNAME="${INSTALL_HOSTNAME:-lunariod}"
    log "Hostname: $INSTALL_HOSTNAME"
}

get_username() {
    USERNAME=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nUsername (will have sudo):" 9 50 "" 2>&1 >/dev/tty) || exit 1
    [[ -n "$USERNAME" ]] || die "Username cannot be empty."
    [[ "$USERNAME" =~ ^[a-z][a-z0-9_-]*$ ]] || die "Invalid username.\nUse lowercase, start with a letter."
    log "Username: $USERNAME"
}

get_password() {
    local p1 p2
    p1=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --insecure --passwordbox "\nPassword:" 9 45 2>&1 >/dev/tty) || exit 1
    p2=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --insecure --passwordbox "\nConfirm password:" 9 45 2>&1 >/dev/tty) || exit 1
    [[ "$p1" == "$p2" ]] || die "Passwords do not match."
    [[ -n "$p1" ]] || die "Password cannot be empty."
    PASSWORD="$p1"
    log "Password: [set]"
}

get_timezone() {
    TIMEZONE=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --inputbox "\nTimezone (e.g. America/New_York, Asia/Kolkata):" \
        9 60 "UTC" 2>&1 >/dev/tty) || exit 1
    TIMEZONE="${TIMEZONE:-UTC}"
    if [[ ! -f "/usr/share/zoneinfo/${TIMEZONE}" ]]; then
        die "Invalid timezone: $TIMEZONE"
    fi
    log "Timezone: $TIMEZONE"
}

get_filesystem() {
    FILESYSTEM=$(dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" \
        --menu "\nRoot filesystem:" 11 45 2 \
        "ext4" "Stable, recommended" \
        "btrfs" "CoW, snapshots" \
        2>&1 >/dev/tty) || exit 1
    log "Filesystem: $FILESYSTEM"
}

###############################################################################
# Config Generation — matches archinstall config schema
###############################################################################
generate_config() {
    cat > "$CONFIG" << JSONEOF
{
    "additional-repositories": ["multilib"],
    "bootloader": "Systemd-boot",
    "hostname": "${INSTALL_HOSTNAME}",
    "kernels": ["linux"],
    "locale_config": {
        "kb_layout": "us",
        "sys_enc": "UTF-8",
        "sys_lang": "en_US"
    },
    "mirror_config": {
        "mirror_regions": {
            "Worldwide": []
        }
    },
    "disk_config": {
        "config_type": "default_layout",
        "device_modifications": [
            {
                "device": "${DISK}",
                "wipe": true
            }
        ]
    },
    "network_config": {
        "type": "nm"
    },
    "packages": [
        "mesa", "lib32-mesa",
        "vulkan-intel", "lib32-vulkan-intel",
        "vulkan-icd-loader", "lib32-vulkan-icd-loader",
        "pipewire", "pipewire-alsa", "pipewire-pulse", "pipewire-jack",
        "wireplumber",
        "hyprland", "xdg-desktop-portal-hyprland", "xdg-desktop-portal",
        "waybar", "wofi", "mako", "hyprpaper", "foot",
        "polkit-gnome", "grim", "slurp", "wl-clipboard",
        "steam", "gamescope", "gamemode", "lib32-gamemode",
        "mangohud", "lib32-mangohud",
        "base-devel", "git", "python", "nodejs", "npm", "firefox",
        "flatpak",
        "virtualbox-guest-utils",
        "networkmanager", "iwd",
        "ttf-jetbrains-mono-nerd", "noto-fonts", "papirus-icon-theme",
        "sudo", "nano", "vim"
    ],
    "profile_config": {
        "profile": {
            "main": "Minimal"
        }
    },
    "timezone": "${TIMEZONE}"
}
JSONEOF

    cat > "$CREDS" << JSONEOF
{
    "!root-password": null,
    "!users": [
        {
            "username": "${USERNAME}",
            "!password": "${PASSWORD}",
            "sudo": true
        }
    ]
}
JSONEOF

    chmod 600 "$CONFIG" "$CREDS"
    log "Config written: $CONFIG"
    log "Creds written: $CREDS"
}

###############################################################################
# Post-Install
###############################################################################
post_install() {
    # archinstall mounts to /mnt/archinstall by default
    if [[ ! -d "$MOUNTPOINT" ]]; then
        MOUNTPOINT="/mnt"
    fi
    log "Post-install mountpoint: $MOUNTPOINT"

    info_box "Running post-install setup..."

    # Enable services
    arch-chroot "$MOUNTPOINT" systemctl enable NetworkManager.service >> "$LOGFILE" 2>&1 || true
    arch-chroot "$MOUNTPOINT" systemctl enable vboxservice.service >> "$LOGFILE" 2>&1 || true

    # Enable multilib in installed system
    sed -i '/^#\[multilib\]/{s/^#//;n;s/^#//}' "$MOUNTPOINT/etc/pacman.conf" 2>/dev/null || true

    # Flatpak + Flathub
    info_box "Setting up Flatpak + Flathub..."
    arch-chroot "$MOUNTPOINT" flatpak remote-add --if-not-exists \
        flathub https://dl.flathub.org/repo/flathub.flatpakrepo >> "$LOGFILE" 2>&1 || true

    # VS Code
    info_box "Installing VS Code (Flatpak)..."
    arch-chroot "$MOUNTPOINT" flatpak install -y --noninteractive \
        flathub com.visualstudio.code >> "$LOGFILE" 2>&1 || true

    # Prism Launcher
    info_box "Installing Prism Launcher (Flatpak)..."
    arch-chroot "$MOUNTPOINT" flatpak install -y --noninteractive \
        flathub org.prismlauncher.PrismLauncher >> "$LOGFILE" 2>&1 || true

    # Deploy user configs
    local user_home="$MOUNTPOINT/home/${USERNAME}"
    if [[ -d "$user_home" ]]; then
        info_box "Deploying desktop configs..."
        mkdir -p "$user_home/.config"
        cp -r /etc/skel/.config/hypr "$user_home/.config/" 2>/dev/null || true
        cp -r /etc/skel/.config/waybar "$user_home/.config/" 2>/dev/null || true
        cp -r /etc/skel/.config/wofi "$user_home/.config/" 2>/dev/null || true
        arch-chroot "$MOUNTPOINT" chown -R "${USERNAME}:${USERNAME}" "/home/${USERNAME}/.config" >> "$LOGFILE" 2>&1 || true
    fi

    # Branding
    [[ -f /etc/os-release ]] && cp /etc/os-release "$MOUNTPOINT/etc/os-release" 2>/dev/null || true

    # Gaming tweak
    echo "vm.max_map_count=2147483642" > "$MOUNTPOINT/etc/sysctl.d/80-gamecompatibility.conf" 2>/dev/null || true

    # Enable sudo for wheel
    sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' "$MOUNTPOINT/etc/sudoers" 2>/dev/null || true

    log "Post-install complete"
}

###############################################################################
# Main
###############################################################################
main() {
    check_prereqs

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --yesno \
        "\n  Welcome to Lunariod!\n\n  This will install Lunariod Linux.\n\n  Continue?" \
        11 50 || exit 0

    get_disk
    get_hostname
    get_username
    get_password
    get_timezone
    get_filesystem

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --yesno \
        "\nInstall with these settings?\n\n  Disk:       $DISK\n  Hostname:   $INSTALL_HOSTNAME\n  Username:   $USERNAME\n  Timezone:   $TIMEZONE\n  Filesystem: $FILESYSTEM\n\n  WARNING: $DISK will be ERASED!" 16 55 || exit 0

    generate_config

    info_box "Running archinstall (10-30 min)...\nLog: $LOGFILE"

    log "=== Running archinstall ==="
    if archinstall --config "$CONFIG" --creds "$CREDS" >> "$LOGFILE" 2>&1; then
        log "archinstall OK"
    else
        log "archinstall returned non-zero, continuing with post-install..."
    fi

    post_install

    rm -f "$CONFIG" "$CREDS"

    dialog --title "$DIALOG_TITLE" --backtitle "$DIALOG_BT" --msgbox \
        "\n  Installation complete!\n\n  Remove the media and reboot.\n\n  Log: $LOGFILE" 12 55

    log "=== Installer finished ==="
}

main "$@"
